import socket
import sys
import os
import subprocess
import re
from general import *

class OutdatedScan:

    def __init__(self, url):
        self.url = url
        self.log = list()
        self.log_csv = list()
        self.cek_sukses = False

        self.boot()

    def boot(self):
        self.db_system = file_to_list("db/db_outdated.txt")
        option = "-s -I"
        command = ("curl " + option + " " + self.url + " | grep -e 'Server: '")
        #result = subprocess.Popen(command, stdout=subprocess.PIPE, shell=True)
        process = os.popen(command)
        output = str(process.read())
        cek = re.search("(?:\d|\/|\.)", output)
        if cek:
            system = output.split()
            #print(system)
            for x in system:
                self.scan_system_outdated(x)
            if self.cek_sukses is True:
                self.log_csv.append(self.url)
        else:
            print("cannot scanning web server")
            print("website using " + output)

    def scan_system_outdated(self, system):
        version = system.split("/")
        for line in self.db_system:
            temp = line.split(",")
            nameApp = temp[1].strip("\"")
            current_ver = temp[2].strip("\"")
            if nameApp == (version[0] + "/"):
                running_ver = version[1]
                if nameApp == "Apache/":
                    if current_ver > system:
                        self.log.append(system + " appears to be outdated #current is at least " + current_ver)
                        self.cek_sukses = True
                else:
                    #print(current_ver + " " + running_ver)
                    if current_ver > running_ver:
                        self.log.append(system + " appears to be outdated #current is at least " + nameApp + current_ver)
                        self.cek_sukses = True


    def return_output(self):
        output = self.log
        return output

    def return_output_cvs(self):
        output = self.log_csv
        return output


#OutdatedScan("192.168.10.13")
#OutdatedScan("mangapark.net")