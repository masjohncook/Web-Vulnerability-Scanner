import subprocess
from general import *
from A5.outdated_scan import *
from A5.detailed_error import *

class mainSecMisconf:

    def __init__(self, url, path):
        self.url = url
        self.log = list()
        self.urlLogin = list()
        self.listUrl = file_to_set(path + "/crawled.txt")
        self.dirLogin = file_to_list("db/db_login.txt")

        self.boot()

    def boot(self):
        self.log.append("result scanning system")
        scan = OutdatedScan(self.url)
        for output in scan.return_output():
            self.log.append(output)

        self.log.append(" ")
        self.log.append("result detailed errors")
        for x in self.listUrl:
            for y in self.dirLogin:
                if x.__contains__(y):
                    re = requests.get(x, timeout=5)
                    if re.status_code == 200:
                        self.urlLogin.append(x)
                    break

        if len(self.urlLogin) > 0:
            for url in self.urlLogin:
                print(url)
                self.log.append("result : " + url)
                try:
                    det = DetailedErrorLogin(url)
                    for output in det.return_output():
                        self.log.append(output)
                except:
                    self.log.append("detailed errors - Error")
                self.log.append("")



        else:
            self.log.append("tidak menemukan link login")

    def return_output(self):
        output = self.log
        return output

#mainSecMisconf("192.168.10.8", "../test")