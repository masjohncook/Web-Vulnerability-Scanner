import socket
import sys
import os
import subprocess
import re
from general import *

class OutdatedScan:

    def __init__(self, url):
        self.portList = [21, 22, 25, 110, 443, 3306]
        self.url = url
        self.log = list()

        self.boot()

    def boot(self):
        self.db_system = file_to_list("db_outdated.txt")
        option = "-s -I"
        command = ("curl " + option + " " + self.url + " | grep -e 'Server: '")
        result = subprocess.Popen(command, stdout=subprocess.PIPE, shell=True)
        process = os.popen(command)
        output = str(process.read())
        cek = re.search("(?:\d|\/|\.)", output)
        if cek:
            system = output.split()
            #print(system)
            for x in system:
                self.scan_system_outdated(x)
        else:
            print("cannot scanning web server")
            print("website using " + output)

    def grab_banner(self, ip, port):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            #s = socket.socket()
            s.connect((ip, port))
            print(s.recv(1024))
        except:
            pass

    def scan_system_outdated(self, system):
        version = system.split("/")
        for line in self.db_system:
            temp = line.split(",")
            nameApp = temp[1].strip("\"")
            current_ver = temp[2].strip("\"")
            if nameApp == (version[0] + "/"):
                running_ver = version[1]
                if nameApp == "Apache/":
                    if current_ver > system:
                        self.log.append(system + " appears to be outdated #current is at least " + current_ver)
                else:
                    #print(current_ver + " " + running_ver)
                    if current_ver > running_ver:
                        self.log.append(system + " appears to be outdated #current is at least " + nameApp + current_ver)

        #print("")


    def return_output(self):
        output = self.log
        return output


#OutdatedScan("192.168.10.13")
#OutdatedScan("mangapark.net")