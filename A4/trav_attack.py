from general import *
import re
import requests
from http.cookies import SimpleCookie


class TravAttack:

    def __init__(self, url):
        self.url = url
        self.log = list()
        self.log_csv = list()

        self.boot(self.url)

    def boot(self, url):
        vuln = " "
        fullLink = " "
        part = re.split("([^\?]+)(\?.*=)", url)
        list_attack = file_to_set("db/db_travelsal.txt")
        list_vuln = file_to_set("db/db_trav_vuln.txt")
        berhasil = False
        for list in list_attack:
            fullLink = part[1] + part[2] + list
            req = request()
            req.query(fullLink)
            for find in list_vuln:
                if req.raw.__contains__(find):
                    vuln = list
                    self.log.append("traversal Attack success")
                    berhasil = True
                    break
            if berhasil:
                break

        if berhasil:
            self.log.append(url)
            self.log.append("vulnerabilty with : " + str(vuln))
            self.log.append(" ")
            data = ["Traversal Path Attack", url]
            self.log_csv.append(data)
        else:
            pass

    def return_output(self):
        output = self.log
        return output

    def return_output_csv(self):
        output = self.log_csv
        return output


class request(object):
    def query(self, link, cookie=None):
        if cookie:
            rawdata = "Cookie: " + cookie
            cookie = SimpleCookie()
            cookie.load(rawdata)

        try:
            req = requests.get(link, cookies=cookie, allow_redirects=True, timeout=2)
            self.raw = req.text
            self.code = req.status_code
        except:
            return False
