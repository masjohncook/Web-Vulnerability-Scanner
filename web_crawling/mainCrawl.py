import threading
from queue import Queue
from web_crawling.spider import Spider
from general import *
from configparser import ConfigParser


class MainCrawl:

    def __init__(self, url, path):
        self.DOMAIN_NAME = get_sub_domain_name(url)
        self.PATH_PROJECT = path
        self.HOMEPAGE = url
        self.QUEUE_FILE = self.PATH_PROJECT + '/queue.txt'
        self.CRAWLED_FILE = self.PATH_PROJECT + '/crawled.txt'
        config = ConfigParser()
        config.read('config.ini')
        thread = int(config.get('thread', 'crawl'))
        self.NUMBER_OF_THREADS = thread
        self.queue = Queue()
        self.run = True

        self.boot()

    def boot(self):
        create_data_file(self.PATH_PROJECT, self.HOMEPAGE)
        self.spiders = Spider(self.PATH_PROJECT, self.HOMEPAGE, self.DOMAIN_NAME)

        self.create_workers()
        self.crawl()

    def create_workers(self):
        for _ in range(self.NUMBER_OF_THREADS):
            t = threading.Thread(target=self.work)
            t.daemon = True
            t.start()

    def work(self):
        while self.run:
            url = self.queue.get()
            if self.DOMAIN_NAME in url:
                self.spiders.crawl_page(url)
            else:
                self.spiders.queue.discard(url)
                self.spiders.update_files()
            self.queue.task_done()
        threading.currentThread().join()

    def create_jobs(self):
        for link in file_to_set(self.QUEUE_FILE):
            self.queue.put(link)
        self.queue.join()
        self.crawl()

    def crawl(self):
        queued_links = file_to_set(self.QUEUE_FILE)
        if len(queued_links) > 0:
            self.create_jobs()
        else:
            return

    def return_output(self):
        output = str(len(file_to_list(self.CRAWLED_FILE)))
        return output

    def func_stop_thread(self):
        self.run = False
        return
