import threading
from queue import Queue
from spider import Spider
from domain import *
from general import *


class MainCrawl:

    def __init__(self, url, prname):
        MainCrawl.DOMAIN_NAME = get_sub_domain_name(url)
        MainCrawl.PROJECT_NAME = prname
        MainCrawl.HOMEPAGE = url
        MainCrawl.QUEUE_FILE = self.PROJECT_NAME + '/queue.txt'
        MainCrawl.CRAWLED_FILE = self.PROJECT_NAME + '/crawled.txt'
        MainCrawl.NUMBER_OF_THREADS = 5

        MainCrawl.queue = Queue()
        print(MainCrawl.PROJECT_NAME, MainCrawl.HOMEPAGE, MainCrawl.DOMAIN_NAME)
        Spider(self.PROJECT_NAME, self.HOMEPAGE, self.DOMAIN_NAME)

        self.create_workers()
        self.crawl()

    def boot(self):
        pass

    def create_workers(self):
        for _ in range(MainCrawl.NUMBER_OF_THREADS):
            t = threading.Thread(target=self.work)
            t.daemon = True
            t.start()

    def work(self):
        while True:
            url = MainCrawl.queue.get()
            Spider.crawl_page(threading.current_thread().name, url)
            MainCrawl.queue.task_done()

    def create_jobs(self):
        for link in file_to_set(MainCrawl.QUEUE_FILE):
            MainCrawl.queue.put(link)
        MainCrawl.queue.join()
        MainCrawl.crawl()

    def crawl(self):
        queued_links = file_to_set(MainCrawl.QUEUE_FILE)
        if len(queued_links) > 0:
            print(str(len(queued_links)) + ' links in queue')
            self.create_jobs()

# MainCrawl('https://www.hackthissite.org', 'hack')
# MainCrawl('http://192.168.10.7', 'test')
